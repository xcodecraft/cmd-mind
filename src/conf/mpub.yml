all_args: 
    - !arg &arg_tag 
          name   : "tag"
          hotkey : "t"
          must   : True
          call   : "--tag $tag"
          default: !pipe
              cmd : "${CMD_ROOT}/ext/last_tag"
              args: "${DPRJ} 1"
          values: !pipe
              cmd : "${CMD_ROOT}/ext/last_tag"
              args: "${DPRJ} 5"
    - !arg &arg_group
          name   : "group"
          hotkey : "g"
          call   : "--host $group"
          values : !pipe
              cmd : "${CMD_ROOT}/ext/read_ini"
              args: "-f /data/x/tools/mara-pub/projects/${DPRJ}/hosts"
    - !arg &arg_host
          name   : "host"
          hotkey : "h"
          call   : "--host $host"
          values : !pipe
              cmd : "${CMD_ROOT}/ext/read_ini"
              args: "-f /data/x/tools/mara-pub/projects/${DPRJ}/hosts -a "

    - !arg &arg_env
          name   : "env"
          hotkey : "e"
          must   : True
          call   : "--env $env"
          values:
            - "dev"
            - "lab"
            - "demo"
            - "test"
            - "beta"
            - "online"
            - "online-b"
    - !arg &all_group
          name   : "group"
          hotkey : "g"
          call   : "--host $group"
          values : !pipe
              cmd : "${CMD_ROOT}/ext/read_ini"
              args: "-f /data/x/tools/mara-pub/conf/all.hosts"
    - !arg &all_host 
          name   : "host"
          hotkey : "h"
          call   : "--host $host"
          values : !pipe
              cmd : "${CMD_ROOT}/ext/read_ini"
              args: "-f /data/x/tools/mara-pub/conf/all.hosts -a"

args1 : &commonargs
    - *arg_tag 
    - *arg_host 
    - *arg_group 

args2 : &prjargs
    - *arg_tag 
    - *arg_host 
    - *arg_group 
    - *arg_env

reuse_cmds: 
    - !cmd &pub_cmd
        name : "pub"
        call : "/data/x/tools/mara-pub/rocket_pub.sh --prj ${DPRJ} "
        args : 
            - *all_group 
            - *all_host
            - !arg 
                  name   : "tag"
                  hotkey : "t"
                  must   : True
                  call   : "--tag $tag"
                  default: !pipe
                      cmd : "${CMD_ROOT}/ext/last_tag"
                      args: "${DPRJ} 1 ${DVER}."
                  values: !pipe
                      cmd : "${CMD_ROOT}/ext/last_tag"
                      args: "${DPRJ} 5 ${DVER}."

    - !cmd &prj_pub_cmd
        name : "pub"
        call : "/data/x/tools/mara-pub/rocket_pub.sh --prj ${DPRJ} "
        args : 
            - *all_group 
            - *all_host
            - *arg_env
            - !arg 
                  name   : "tag"
                  hotkey : "t"
                  must   : True
                  call   : "--tag $tag"
                  default: !pipe
                      cmd : "${CMD_ROOT}/ext/last_tag"
                      args: "${DPRJ} 1 ${DVER}."
                  values: !pipe
                      cmd : "${CMD_ROOT}/ext/last_tag"
                      args: "${DPRJ} 5 ${DVER}."

    - !cmd &simple_pub_cmd
        name : "pub"
        vars : 
            PRJ : "rigger-ng "
        call : "/data/x/tools/mara-pub/rocket_pub.sh --prj ${DPRJ}"
        args : *commonargs
    - !cmd &setup_cmd
        name : "setup"
        call : '/data/x/tools/mara-pub/rocket_cmd.sh --command "${SETUP_CMD}"'
        args : 
            - *all_group 
            - *all_host
    - !cmd &fetch_cmd
        name : "fetch"
        call  : '${CMD_ROOT}/ext/git_fetch ${HOME}/devspace/${DPRJ}'

    - !cmd &ver_cmd
        name : "ver"
        call : '/data/x/tools/mara-pub/rocket_cmd.sh --command "/data/x/tools/mara_bin/prj_cmd.sh -p ${DPRJ} -c ver"'
        args : 
            - *all_group 

    - !cmd &restart_cmd
        name : "ver"
        call : '/data/x/tools/mara-pub/rocket_cmd.sh --command "/data/x/tools/mara_bin/prj_cmd.sh -p ${DPRJ} -c restart"'
        args : 
            - *all_group 

    - !cmd &prj_cmd
        name : "${DPRJ}"
        subs:
            - !using 
              origin : *fetch_cmd
            - !using 
              origin : *prj_pub_cmd
            - !using 
              origin : *ver_cmd
            - !using 
              origin : *restart_cmd

    - !cmd &common_cmd
        name : "${DPRJ}"
        subs:
            - !using 
              origin : *fetch_cmd
            - !using 
              origin : *pub_cmd
            - !using 
              origin : *ver_cmd
            - !using 
              origin : *restart_cmd

main : !cmd
    name : "mpub"
    subs :
        - !cmd
            name : "pylon-ng"
            vars :
                DPRJ : "pylon-ng"
            subs :
                - !using 
                  origin : *fetch_cmd
                - !cmd
                    name : "PHP5"
                    vars :
                        DVER : "0.19"
                        SETUP_CMD : "/data/x/libs/pylon-ng/modules/setup.sh"
                    subs :
                        - !using 
                          origin : *setup_cmd
                        - !using 
                          origin : *pub_cmd
                - !cmd
                    name : "PHP7"
                    vars :
                        DVER : "0.20"
                        SETUP_CMD : "/data/x/libs/pylon-ng-0.20/modules/setup.sh"

                    subs :
                        - !using 
                          origin : *setup_cmd
                        - !using 
                          origin : *pub_cmd

        - !using
            vars :
                DVER : ""
                DPRJ : "rigger-ng"
            origin : *common_cmd
        - !using
            vars :
                DVER : ""
                DPRJ : "mara_bin"
            origin : *common_cmd
        - !using
            vars :
                DVER : ""
                DPRJ : "team"
            origin : *common_cmd

        - !using
            vars :
                DVER : ""
                DPRJ : "cmd-mind"
            origin : *common_cmd

        - !using
            vars :
                DVER : ""
                DPRJ : "aliyun_sdks"
            origin : *common_cmd


        - !using
            vars :
                DVER : ""
                DPRJ : "api-hub"
            origin : *common_cmd

        - !using
            vars :
                DVER : ""
                DPRJ : "mara_sdk"
            origin : *common_cmd

        - !using
            vars :
                DVER : ""
                DPRJ : "xcc_sdks"
            origin : *common_cmd

        - !using
            vars :
                DVER : ""
                DPRJ : "marathon-web"
            origin : *prj_cmd

        - !using
            vars :
                DVER : ""
                DPRJ : "mara-hd"
            origin : *prj_cmd

        - !using
            vars :
                DVER : ""
                DPRJ : "user-gateway"
            origin : *prj_cmd


        - !using
            vars :
                DVER : ""
                DPRJ : "uac"
            origin : *prj_cmd
        - !using
            vars :
                DVER : ""
                DPRJ : "louis-web"
            origin : *prj_cmd

